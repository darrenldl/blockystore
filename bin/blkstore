#!/usr/bin/env python3
import argparse
import shutil
import ipaddress
from packaging import version
import re
import subprocess

blkar_name="blkar"
blkar_min_ver=version.parse("6.0.0")
blkar_max_ver_exc=version.parse("7.0.0")

default_port=20000

def check_for_blkar_installation():
    if shutil.which(blkar_name) == None:
        print(blkar_name + " not detected, please make sure you have installed blkar correctly")
        exit(1)

    ver_str = re.match("blkar (.*)\n", subprocess.check_output(["blkar", "--version"]).decode("utf-8")).group(1)
    ver = version.parse(ver_str)
    if ver < blkar_min_ver or ver >= blkar_max_ver_exc:
        print("Version " + ver_str + " not supported, version must be >=" + blkar_min_ver + " && < " + blkar_max_ver_exc)
        exit(1)

def main():
    check_for_blkar_installation()
    parser = argparse.ArgumentParser()
    subparsers = parser.add_subparsers(help="subcommand help")

    parser_serve = subparsers.add_parser("serve", help="Launch in server mode")
    parser_serve.add_argument("-p", metavar="PORT", required=True, type=int, help="Localhost port to listen on, defaults to " + str(default_port))
    parser_serve.add_argument("dir", help="Directory for file storage")

    parser_upload = subparsers.add_parser("upload", help="Upload file to server")
    parser_upload.add_argument("addr", type=ipaddress.ip_address, help="Address to connect to")
    parser_upload.add_argument("-p", metavar="PORT", required=True, type=int, help="Port to connect to, defaults to " + str(default_port))

    parser_download = subparsers.add_parser("download", help="Download file from server")
    parser_download.add_argument("addr", type=ipaddress.ip_address, help="Address to connect to")
    parser_download.add_argument("-p", metavar="PORT", required=True, type=int, help="Port to connect to, defaults to " + str(default_port))

    parser.parse_args()

if __name__ == "__main__":
    main()
